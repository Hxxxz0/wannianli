# 崇新学堂 开发创新性实践 I

## 📚 课程项目：智能万年历 - ESP32多功能显示器

## 🌟 项目概述

基于ESP32的智能万年历系统，集成了时间显示、天气预报、环境监测、火焰报警、音频播放等多种功能。支持农历显示、闹钟提醒、事件管理和Web配置界面，是一个功能完整的桌面智能终端。

## 🛠️ 硬件要求

### 主要硬件组件
- **ESP32开发板**：主控芯片
- **TFT_eSPI兼容显示屏**：显示界面
- **MAX98357音频放大器**：音频输出
- **DHT11温湿度传感器**：环境监测
- **火焰传感器**：安全报警
- **3个按键**：界面控制

### 引脚连接
```
音频系统 (MAX98357):
- BCLK: GPIO 15
- LRC/WS: GPIO 16  
- DIN: GPIO 7
- SD: 3.3V (启用放大器)

传感器连接:
- DHT11: GPIO 10
- 火焰传感器 DO: GPIO 9
- 火焰传感器 AO: GPIO 8
```

## 📚 环境配置教程

### 第一步：安装开发环境

#### 1. 安装 PlatformIO IDE
```bash
# 方法1：使用VS Code扩展
1. 安装 Visual Studio Code
2. 在扩展商店搜索 "PlatformIO IDE"
3. 安装 PlatformIO IDE 扩展

# 方法2：使用命令行安装
pip install platformio
```

#### 2. 安装必要的驱动
- **ESP32驱动**：确保电脑能识别ESP32开发板
- **CP2102/CH340驱动**：根据开发板的USB芯片型号安装

### 第二步：克隆项目

```bash
# 克隆项目到本地
git clone https://github.com/Hxxxz0/wannianli.git
cd wannianli

# 或者下载ZIP文件解压
```

### 第三步：配置 PlatformIO 项目

#### 1. 打开项目
```bash
# 使用VS Code打开项目目录
code .

# 或者在VS Code中：File -> Open Folder -> 选择项目目录
```

#### 2. 检查 platformio.ini 配置
```ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
board_build.partitions = huge_app.csv

lib_deps = 
    bodmer/TFT_eSPI@^2.5.0
    bblanchon/ArduinoJson@^6.21.3
    arduino-libraries/NTPClient@^3.2.1
    me-no-dev/ESPAsyncWebServer@^1.2.3
    adafruit/DHT sensor library@^1.4.4
    earlephilhower/ESP8266Audio@^1.9.7
```

#### 3. 配置 TFT_eSPI 显示库
```cpp
// 在 User_Setup.h 中配置显示屏参数
// 位置：~/.platformio/packages/framework-arduinoespressif32/libraries/TFT_eSPI/User_Setup.h

// 取消注释您的显示屏型号，例如：
#define ST7735_DRIVER
// 或
#define ILI9341_DRIVER

// 配置引脚连接
#define TFT_CS   5
#define TFT_DC   2
#define TFT_RST  4
```

### 第四步：准备文件系统

#### 1. 创建 data 目录
```bash
mkdir -p data
```

#### 2. 添加音频文件
```bash
# 将音频文件放入 data 目录
cp your_music.mp3 data/compressed_smaller.mp3
cp your_alarm.mp3 data/beep_burst.mp3
```

#### 3. 上传文件系统
```bash
# 在PlatformIO终端中执行
pio run --target uploadfs
```

### 第五步：编译和上传

#### 1. 编译项目
```bash
# 在PlatformIO终端中执行
pio run

# 或使用VS Code界面：
# 点击底部状态栏的 "✓" 按钮
```

#### 2. 上传到ESP32
```bash
# 连接ESP32到电脑，执行：
pio run --target upload

# 或使用VS Code界面：
# 点击底部状态栏的 "→" 按钮
```

#### 3. 监控串口输出
```bash
# 查看运行日志
pio device monitor

# 或使用VS Code界面：
# 点击底部状态栏的 "🔌" 按钮
```

### 第六步：首次配置

#### 1. 连接设备热点
```
1. ESP32启动后会创建名为 "TV-PRO" 的热点
2. 使用手机/电脑连接此热点（无密码）
3. 打开浏览器访问：http://192.168.4.1
```

#### 2. 配置WiFi连接
```
1. 在配置页面输入您的WiFi名称和密码
2. 点击"更新WiFi设置"
3. 设备将自动重启并连接到您的WiFi
```

#### 3. 获取天气API密钥
```
1. 访问心知天气官网：https://www.seniverse.com/
2. 注册账户并获取免费API密钥
3. 在设备配置页面输入API密钥
```

### 第七步：功能测试

#### 1. 基本功能测试
```bash
# 检查串口输出，确认以下功能正常：
- WiFi连接成功
- 时间同步成功
- 天气数据获取成功
- 传感器数据读取正常
```

#### 2. 音频功能测试
```bash
# 在Web配置界面测试：
- 点击"播放音乐"按钮
- 点击"蜂鸣器测试"按钮
- 检查是否有声音输出
```

#### 3. 页面切换测试
```bash
# 使用按键测试：
- 左键：上一页
- 右键：下一页
- 中键短按：返回主页
- 中键长按：进入配置模式
```

## 🔧 常见问题解决

### 编译错误
```bash
# 错误：找不到库文件
解决：检查 lib_deps 配置，确保所有依赖库正确安装

# 错误：分区表问题
解决：在 platformio.ini 中添加：
board_build.partitions = huge_app.csv
```

### 上传失败
```bash
# 错误：无法连接到设备
解决：
1. 检查USB线缆和驱动程序
2. 按住ESP32的BOOT按钮，点击RST按钮
3. 尝试降低上传速度：upload_speed = 115200
```

### 显示屏不显示
```bash
# 问题：屏幕黑屏或显示异常
解决：
1. 检查显示屏引脚连接
2. 确认 TFT_eSPI 库配置正确
3. 验证显示屏驱动型号
```

### WiFi连接失败
```bash
# 问题：无法连接WiFi
解决：
1. 确认WiFi名称和密码正确
2. 检查WiFi是否为2.4GHz频段
3. 查看串口输出的错误信息
```

## 🌟 核心功能

### 📱 网络配置系统
- **热点配置模式**：首次使用自动创建`TV-PRO`热点
- **Web配置界面**：`http://192.168.4.1` 或设备IP访问
- **WiFi自动重连**：网络故障自动重连，失败超过5次自动重启热点
- **网络状态显示**：实时显示WiFi信号强度和连接状态

### ⏰ 时间与日期系统
- **精确时间显示**：NTP自动校时，支持12/24小时制
- **公历完整显示**：年/月/日/星期完整信息
- **农历日期支持**：完整农历计算，支持闰月处理
- **模拟时钟页面**：经典指针式时钟显示

### 🌤️ 天气预报系统
- **心知天气API**：实时获取准确天气数据
- **温度湿度显示**：当前温度、湿度、天气状况
- **天气图标系统**：根据天气状况自动切换图标
- **城市自定义**：支持任意城市天气查询
- **API密钥配置**：通过Web界面配置个人API密钥

### 🎵 音频系统
- **MP3音乐播放**：支持SPIFFS存储的MP3文件
- **I2S音频输出**：高品质数字音频输出
- **音频任务管理**：独立音频任务，避免阻塞主程序
- **音乐循环播放**：自动循环播放功能
- **音量控制**：Web界面音量调节（0.0-4.0）
- **多场景音效**：
  - 闹钟铃声：`/compressed_smaller.mp3`
  - 火警报警：`/beep_burst.mp3`

### 🌡️ 环境监测系统
- **DHT11温湿度传感器**：实时监测室内环境
- **数据采集间隔**：2秒更新一次，避免传感器过热
- **环境数据显示**：温度、湿度实时显示
- **数据历史记录**：保存监测数据供查看

### 🔥 火焰检测与报警系统
- **双重检测机制**：
  - 数字输出(DO)：快速触发检测
  - 模拟输出(AO)：精确阈值检测（阈值40%）
- **报警响应**：
  - 立即播放警报音效
  - 显示屏切换到火警页面
  - 自动发送邮件通知
- **SMTP邮件通知**：支持Gmail等邮件服务器
- **报警状态管理**：自动检测和手动重置

### ⏰ 闹钟与提醒系统
- **多重闹钟**：最多3个独立闹钟
- **闹钟功能**：
  - 自定义时间设置
  - 个性化标签
  - 开启/关闭切换
  - 音乐铃声提醒
- **事件提醒**：最多4个重要事件
- **事件功能**：
  - 支持日期和时间设置
  - 全天事件或定时事件
  - 提前一天提醒选项
  - 自定义标题和描述

### 📺 多页面显示系统
- **6个主要页面**：
  1. **主页面**：时间、日期、天气概览
  2. **详细天气页**：完整天气信息
  3. **闹钟页面**：所有闹钟状态和设置
  4. **事件页面**：待办事项和重要日期
  5. **网络信息页**：设备状态和网络信息
  6. **模拟时钟页**：经典指针式时钟
- **特殊页面**：
  - **火警报警页**：火焰检测触发时显示
- **页面控制**：
  - 自动轮转功能（可设置间隔：5/10/15/30秒）
  - 手动按键切换
  - 智能刷新机制

### 🎛️ 按键操作系统
- **左键**：切换到上一页
- **右键**：切换到下一页  
- **中键短按**：返回主页面
- **中键长按**：进入配置模式

## 🔧 Web配置界面

### 配置功能
- **网络设置**：WiFi SSID和密码配置
- **天气设置**：城市选择和API密钥配置
- **显示设置**：
  - 12/24小时制切换
  - 农历显示开关
  - 页面自动轮转设置
  - 轮转间隔调整
- **闹钟管理**：添加、编辑、删除闹钟
- **事件管理**：重要日期和提醒设置
- **音频控制**：音乐播放控制和测试
- **设备信息**：实时查看设备状态

### 操作指南
1. **初始配置**：
   - 首次启动连接`TV-PRO`热点
   - 访问`http://192.168.4.1`进行基础配置
   - 设置WiFi连接信息

2. **正常使用**：
   - 联网后通过设备IP访问
   - 按右键4次进入网络信息页查看IP
   - 访问`http://[设备IP]`进行详细设置

## 📄 文件系统结构

```
/data/
├── compressed_smaller.mp3  # 闹钟音乐文件
├── beep_burst.mp3          # 火警报警音效
└── index.html              # 备用Web页面

配置文件 (SPIFFS):
├── /ssid.json              # WiFi配置
├── /settings.json          # 显示设置
├── /alarms.json            # 闹钟配置
└── /events.json            # 事件配置
```

## 🔧 技术规格

### 软件架构
- **多任务系统**：
  - 主任务：界面显示和逻辑控制
  - 音频任务：独立音频处理
  - Web服务器：异步HTTP处理
- **文件系统**：SPIFFS存储配置和音频文件
- **网络协议**：HTTP/HTTPS、SMTP、NTP
- **音频格式**：MP3 (通过ESP32-audioI2S库)

### API接口
- **天气服务**：心知天气API
- **时间同步**：NTP服务器
- **邮件发送**：SMTP协议（支持SSL/TLS）

### 性能参数
- **显示刷新**：实时更新，智能刷新策略
- **网络检测**：30秒检测一次WiFi状态
- **传感器读取**：2秒间隔读取DHT11数据
- **火焰检测**：实时监测，立即响应

## 🔒 安全特性

- **火焰检测**：双重检测机制，误报率低
- **邮件通知**：异常情况自动通知
- **网络安全**：支持加密WiFi连接
- **配置保护**：重要配置文件自动备份

## 📦 依赖库

```ini
[lib_deps]
    bodmer/TFT_eSPI@^2.5.0
    bblanchon/ArduinoJson@^6.21.3
    arduino-libraries/NTPClient@^3.2.1
    me-no-dev/ESPAsyncWebServer@^1.2.3
    adafruit/DHT sensor library@^1.4.4
    earlephilhower/ESP8266Audio@^1.9.7
```

## 📝 使用注意事项

1. **音频文件**：
   - 仅支持MP3格式
   - 建议文件大小小于1MB
   - 确保SPIFFS空间充足

2. **网络配置**：
   - 需要稳定的2.4GHz WiFi连接
   - 天气功能需要获取心知天气API密钥
   - 邮件通知需要配置SMTP服务器

3. **传感器使用**：
   - DHT11需要2秒以上读取间隔
   - 火焰传感器需要合适的安装位置
   - 避免传感器接触水分

4. **维护建议**：
   - 定期检查传感器状态
   - 监控存储空间使用情况
   - 备份重要配置文件

## 🔄 更新日志

### 当前版本特性
- ✅ 完整的音频系统，替代简单蜂鸣器
- ✅ 火焰检测和报警系统
- ✅ SMTP邮件通知功能
- ✅ 多页面显示系统优化
- ✅ 传感器数据采集优化
- ✅ Web配置界面美化
- ✅ 农历计算系统完善
- ✅ 闹钟和事件提醒系统

### 未来规划
- 🔲 支持更多音频格式
- 🔲 添加更多传感器支持
- 🔲 云端数据同步
- 🔲 移动APP控制
- 🔲 语音控制功能

## 🤝 贡献指南

欢迎提交Issue和Pull Request来完善项目！

## 📄 许可证

MIT License - 详见LICENSE文件

---

**课程**：崇新学堂 开发创新性实践 I  
**项目作者**：课程学员  
**GitHub**：https://github.com/Hxxxz0/wannianli  
**更新时间**：2024年 